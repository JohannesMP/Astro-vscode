name: Astro
scopeName: source.astro
fileTypes:
  - '.astro'

patterns:
  - include: '#javascript'
  - include: '#html'

repository:
  javascript:
    patterns:
      - name: meta.block.js
        begin: '\A\s*^---$'
        end: '(?=^---$)'
        patterns:
          - include: 'source.js'

  html:
    patterns:
      - name: meta.block.html
        begin: '(?<!\A)\s*^---$'
        end: '(?<=</html>)\s*$\Z'
        patterns:
          - include: 'text.html.basic#tags-valid'
          - include: 'text.html.basic#entities'
          - include: 'text.html.basic#doctype'
          - include: 'text.html.basic#comment'
          - include: '#astro'

  astro:
    patterns:
      - include: '#inline-javascript'
      - include: '#components'

    repository:

      inline-javascript:
        patterns:
          - name: meta.inline.js
            begin: '(?<!\\){'
            end: '(?<!\\)}'
            patterns:
              - include: 'source.js'

      components:
        patterns:
          - name: meta.component.astro
            begin: '</?(?=[A-Z])'
            end: '/?>'
            captures:
              0: { name: punctuation.definition.tag.component.astro }
            patterns:
              - name: entity.name.type.component.astro
                match: '(?<=</?)[A-Z]\w*'
              - include: 'text.html.basic#attribute'
